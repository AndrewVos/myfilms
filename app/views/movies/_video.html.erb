<div id="youtube-player"></div>
<script>
  var reloadYoutube = function () {
    if (window.YT) {
      return
    }
    var tag = document.createElement('script')
    tag.src = "https://www.youtube.com/player_api"
    var firstScriptTag = document.getElementsByTagName('script')[0]
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)
  }

  reloadYoutube()

  $(document).on('turbolinks:load', function() {
    onYouTubeIframeAPIReady && onYouTubeIframeAPIReady()
  })

  var youtubePlayer = null
  function onYouTubeIframeAPIReady() {
    if (!window.YT || window.youtubePlayer) {
      return
    }

    youtubePlayer = new YT.Player('youtube-player', {
      height: '90%',
      width: '100%',
      videoId: '<%= youtube_video_id %>',
      events: {
        onReady: onPlayerReady,
        onStateChange: onPlayerStateChange,
        onError: onError
      }
    })
  }

  function onError(event) {
    navigateToNextDiscovery()
  }

  function onPlayerReady(event) {
    event.target.playVideo()
  }

  function onPlayerStateChange(event) {
    if(event.data === 0) {
      navigateToNextDiscovery()
    }
  }

  function navigateToNextDiscovery() {
    window.location = '<%= next_page_path.html_safe %>'
  }
</script>
